---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import formatDate from "@/utils/formatDate";
import { getArticleSchema, SEO_CONFIG } from "@/data/seo";
import { SITE_URL } from "@/data/config";

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<"posts">;
};

const { post } = Astro.props;
const { Content } = await post.render();

const siteUrl = SITE_URL.endsWith('/') ? SITE_URL.slice(0, -1) : SITE_URL;
const articleUrl = `${siteUrl}/tutorials/${post.slug}`;

const articleSchema = getArticleSchema({
  title: post.data.title,
  description: post.data.description,
  url: articleUrl,
  publishedAt: post.data.publishedAt,
  siteUrl,
});
---

<Layout 
  title={`${post.data.title} | ${SEO_CONFIG.siteName}`}
  description={post.data.description}
  keywords={["tutorial", "blog", "technical article"]}
  jsonLd={articleSchema}
  og={{
    title: post.data.title,
    type: "article",
    description: post.data.description,
  }}
>
  <main class="post mx-auto flex w-full max-w-prose flex-col gap-4">
    <header role="presentation">
      <h1 class="text-md">
        {post.data.title} - {formatDate(post.data.publishedAt)}
      </h1>
      <p class="italic">{post.data.description}</p>
    </header>

    <Content />
  </main>
</Layout>

<script>
  // Add copy button to all code blocks
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('.post pre');

    codeBlocks.forEach((pre) => {
      // Create copy button
      const button = document.createElement('button');
      button.className = 'copy-code-btn absolute top-2 right-2 px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-neutral-200 dark:bg-neutral-800 hover:bg-neutral-300 dark:hover:bg-neutral-700 text-neutral-700 dark:text-neutral-300';
      button.textContent = 'Copy';

      // Add click handler
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (code) {
          await navigator.clipboard.writeText(code.textContent || '');
          button.textContent = 'Copied!';
          button.classList.add('bg-green-500', 'text-white', 'dark:bg-green-600');

          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('bg-green-500', 'text-white', 'dark:bg-green-600');
          }, 2000);
        }
      });

      pre.appendChild(button);
    });
  });
</script>
